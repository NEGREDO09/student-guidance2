<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>í•™ìƒ ìƒí™œ ì§€ë„ ê¸°ë¡ ì‹œìŠ¤í…œ</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <style>
    body { font-family: 'Noto Sans KR', sans-serif; }
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,.5);
      display:flex; justify-content:center; align-items:center; z-index:1000;
    }
    #alert-confirm-modal, #year-end-modal, #prompt-modal { z-index: 1001; }
    .modal-content {
      background:white; padding:1.5rem; border-radius:.5rem;
      width:95%; max-width:600px; box-shadow:0 4px 6px rgba(0,0,0,.1);
      transition: all .3s ease;
    }
    .modal-content.danger{ background:#fef2f2; border:2px solid #ef4444; }
    .hidden{ display:none; }
    .break-keep{ word-break: keep-all; }
    .loader{
      border:4px solid #f3f3f3; border-top:4px solid #3498db; border-radius:50%;
      width:24px; height:24px; animation:spin 1s linear infinite;
    }
    @keyframes spin{ 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
  </style>
</head>
<body class="bg-gray-100">

  <div id="app-container" class="min-h-screen flex flex-col items-center justify-center p-4 hidden">

    <!-- ë¡œê·¸ì¸ -->
    <div id="login-section" class="w-full max-w-md bg-white p-8 rounded-lg shadow-lg">
      <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">í•™ìƒ ìƒí™œ ì§€ë„ ì‹œìŠ¤í…œ</h1>
      <div class="mb-4">
        <label for="login-name" class="block text-gray-700 text-sm font-bold mb-2">ì´ë¦„ (ì•„ì´ë””)</label>
        <input id="login-name" type="text" class="shadow border rounded w-full py-2 px-3 text-gray-700 focus:outline-none" placeholder="ê°€ì…í•˜ì‹  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"/>
      </div>
      <div class="mb-6">
        <label for="password" class="block text-gray-700 text-sm font-bold mb-2">ë¹„ë°€ë²ˆí˜¸</label>
        <input id="password" type="password" class="shadow border rounded w-full py-2 px-3 text-gray-700 focus:outline-none" placeholder="******************"/>
      </div>
      <button id="login-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full flex items-center justify-center">
        <span class="btn-text">ë¡œê·¸ì¸</span><div class="loader hidden ml-2"></div>
      </button>
      <p id="login-error" class="text-red-500 text-xs italic mt-4 text-center"></p>

      <div class="text-center mt-4">
        <a href="#" id="show-register-link" class="font-bold text-sm text-blue-500 hover:text-blue-800">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? íšŒì›ê°€ì…</a>
      </div>
    </div>

    <!-- íšŒì›ê°€ì… -->
    <div id="register-section" class="w-full max-w-md bg-white p-8 rounded-lg shadow-lg hidden">
      <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">íšŒì›ê°€ì…</h1>
      <div class="mb-4">
        <label for="register-name" class="block text-gray-700 text-sm font-bold mb-2">ì´ë¦„ (ì•„ì´ë””ë¡œ ì‚¬ìš©)</label>
        <input id="register-name" type="text" class="shadow border rounded w-full py-2 px-3 text-gray-700" placeholder="í™ê¸¸ë™"/>
      </div>
      <div class="mb-4">
        <label for="register-password" class="block text-gray-700 text-sm font-bold mb-2">ë¹„ë°€ë²ˆí˜¸</label>
        <input id="register-password" type="password" class="shadow border rounded w-full py-2 px-3 text-gray-700" placeholder="6ìë¦¬ ì´ìƒ"/>
      </div>
      <div class="mb-6">
        <label for="register-code" class="block text-gray-700 text-sm font-bold mb-2">ê°€ì… ì½”ë“œ</label>
        <input id="register-code" type="text" class="shadow border rounded w-full py-2 px-3 text-gray-700" placeholder="ê´€ë¦¬ìì—ê²Œ ë°›ì€ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”"/>
      </div>
      <button id="register-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded w-full flex items-center justify-center">
        <span class="btn-text">ê°€ì…í•˜ê¸°</span><div class="loader hidden ml-2"></div>
      </button>

      <div class="text-center mt-4">
        <a href="#" id="show-login-link" class="font-bold text-sm text-blue-500 hover:text-blue-800">ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
      </div>
    </div>

    <!-- ë©”ì¸ -->
    <div id="main-app-section" class="w-full max-w-md hidden">
      <div class="bg-white p-6 md:p-8 rounded-lg shadow-lg">

        <div class="flex justify-between items-center mb-6">
          <h1 id="main-title" class="text-xl md:text-2xl font-bold text-gray-800 break-keep"></h1>
          <button id="logout-btn" class="bg-gray-500 hover:bg-gray-700 text-white text-sm font-bold py-1 px-3 rounded">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label for="violation-date" class="block text-gray-700 text-sm font-bold mb-2">ë‚ ì§œ</label>
            <input id="violation-date" type="date" class="shadow border rounded w-full py-2 px-3 text-gray-700 focus:outline-none"/>
          </div>
          <div>
            <label for="student-id" class="block text-gray-700 text-sm font-bold mb-2">í•™ë²ˆ (ì˜ˆ: 1101)</label>
            <input id="student-id" type="text" class="shadow border rounded w-full py-2 px-3 text-gray-700 focus:outline-none" placeholder="í•™ë…„ë°˜ë²ˆí˜¸"/>
          </div>
        </div>
        <div class="mb-4">
          <label for="student-name" class="block text-gray-700 text-sm font-bold mb-2">ì´ë¦„</label>
          <input id="student-name" type="text" class="shadow border rounded w-full py-2 px-3 text-gray-700 focus:outline-none" placeholder="í•™ìƒ ì´ë¦„"/>
        </div>
        <div class="mb-6">
          <label for="violation-details" class="block text-gray-700 text-sm font-bold mb-2">ìœ„ë°˜ ë‚´ì—­</label>
          <input id="violation-details" type="text" class="shadow border rounded w-full py-2 px-3 text-gray-700 focus:outline-none" placeholder="ì˜ˆ: ì‚¬ë³µ ì°©ìš©, ì§€ì‹œ ë¶ˆì´í–‰"/>
        </div>

        <button id="submit-btn" class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded w-full flex items-center justify-center">
          <span class="btn-text">ìœ„ë°˜ ì‚¬í•­ ì œì¶œ</span><div class="loader hidden ml-2"></div>
        </button>
      </div>

      <!-- êµì‚¬/ê´€ë¦¬ì ì¡°íšŒ -->
      <div id="teacher-menu" class="mt-6 bg-white p-4 rounded-lg shadow-lg hidden">
        <h2 class="text-lg font-semibold text-center mb-3 text-gray-600">ì¡°íšŒ ë©”ë‰´</h2>
        <button id="view-by-class-btn" class="bg-cyan-500 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded w-full">ë°˜ë³„ ìœ„ë°˜ ì¡°íšŒ</button>
      </div>

      <!-- ê´€ë¦¬ì ê¸°ëŠ¥ -->
      <div id="admin-controls" class="mt-6 hidden">
        <h2 class="text-lg font-semibold text-center mb-2 text-gray-600">ê´€ë¦¬ì ë©”ë‰´</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <button id="manage-students-btn" class="bg-teal-500 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded">í•™ìƒ ê°œë³„ ê´€ë¦¬</button>
          <button id="bulk-upload-btn" class="bg-orange-500 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded">ì—‘ì…€ë¡œ ì¼ê´„ ë“±ë¡</button>
          <!-- í•­ìƒ í™œì„± (ì´ì „ ì½”ë“œì˜ ì¡°ê±´ë¶€ ë¹„í™œì„± ì œê±°) -->
          <button id="show-stats-btn" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded" title="ì´ë²ˆ ë‹¬ í†µê³„ ë³´ê¸°">ì›”ë³„ í†µê³„ ë³´ê¸°</button>
          <button id="manage-codes-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">ê°€ì… ì½”ë“œ ê´€ë¦¬</button>
          <button id="edit-title-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">í˜ì´ì§€ ì œëª© ìˆ˜ì •</button>
          <button id="year-end-btn" class="bg-red-600 hover:bg-red-800 text-white font-bold py-2 px-4 rounded">ìƒˆ í•™ë…„ë„ ì¤€ë¹„</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ë¡œë”© -->
  <div id="loading-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-gray-100">
    <div class="w-full max-w-xs">
      <p id="loading-status" class="mb-2 text-center text-gray-600">ì‹œìŠ¤í…œì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      <div class="w-full bg-gray-200 rounded-full h-2.5">
        <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width:0%"></div>
      </div>
    </div>
  </div>

  <!-- ëª¨ë‹¬ë“¤ -->
  <div id="result-modal" class="modal-backdrop hidden">
    <div class="modal-content" id="result-modal-content-box">
      <h2 id="result-modal-title" class="text-2xl font-bold mb-4 text-gray-800">ê¸°ë¡ ì™„ë£Œ</h2>
      <div id="result-content" class="text-gray-700 space-y-2"></div>
      <button id="result-modal-ok-btn" class="mt-6 w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">í™•ì¸</button>
    </div>
  </div>

  <div id="alert-confirm-modal" class="modal-backdrop hidden">
    <div class="modal-content">
      <h2 id="ac-modal-title" class="text-xl font-bold mb-4 text-gray-800">ì•Œë¦¼</h2>
      <p id="ac-modal-message" class="text-gray-700"></p>
      <div id="ac-modal-buttons" class="mt-6 flex justify-end gap-4">
        <button id="ac-modal-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">ì·¨ì†Œ</button>
        <button id="ac-modal-ok-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">í™•ì¸</button>
      </div>
    </div>
  </div>

  <div id="class-selector-modal" class="modal-backdrop hidden">
    <div class="modal-content">
      <h2 id="class-selector-title" class="text-2xl font-bold mb-4 text-gray-800">ì¡°íšŒí•  í•™ê¸‰ ì„ íƒ</h2>
      <div id="class-selector-container" class="space-y-4"></div>
      <div class="mt-6 flex justify-end gap-4">
        <button id="class-selector-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">ì·¨ì†Œ</button>
        <button id="class-selector-confirm-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">ì¡°íšŒ</button>
      </div>
    </div>
  </div>

  <div id="student-list-modal" class="modal-backdrop hidden">
    <div class="modal-content">
      <h2 class="text-2xl font-bold mb-4 text-gray-800">í•™ìƒ ëª…ë ¬ ê´€ë¦¬</h2>
      <div id="student-list-selector" class="mb-4"></div>

      <div class="mb-4 bg-gray-100 p-3 rounded-md">
        <h3 class="font-semibold mb-2">ì‹ ê·œ í•™ìƒ ì¶”ê°€ (í˜„ì¬ ì„ íƒëœ í•™ê¸‰)</h3>
        <div class="flex gap-2">
          <input id="new-student-id-suffix" type="text" placeholder="ë²ˆí˜¸ (ì˜ˆ: 01)" class="w-1/3 p-2 border rounded"/>
          <input id="new-student-name" type="text" placeholder="ì´ë¦„" class="w-2/3 p-2 border rounded"/>
          <button id="add-student-btn" class="bg-blue-500 text-white px-3 rounded hover:bg-blue-600 flex items-center justify-center">
            <span class="btn-text">ì¶”ê°€</span><div class="loader hidden ml-2"></div>
          </button>
        </div>
      </div>

      <div id="student-list-content" class="max-h-64 overflow-y-auto"></div>
      <button onclick="document.getElementById('student-list-modal').classList.add('hidden')" class="mt-6 w-full bg-teal-500 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded">ë‹«ê¸°</button>
    </div>
  </div>

  <div id="class-log-modal" class="modal-backdrop hidden">
    <div class="modal-content">
      <div class="flex justify-between items-center">
        <h2 id="class-log-title" class="text-2xl font-bold text-gray-800"></h2>
        <button id="class-log-export-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded text-sm">ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸°</button>
      </div>
      <div id="class-log-content" class="mt-4 max-h-96 overflow-y-auto"></div>
      <button id="class-log-close-btn" class="mt-6 w-full bg-cyan-500 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded">ë‹«ê¸°</button>
    </div>
  </div>

  <div id="stats-modal" class="modal-backdrop hidden">
    <div class="modal-content">
      <div class="flex justify-between items-center">
        <h2 id="stats-title" class="text-2xl font-bold text-gray-800"></h2>
        <button id="stats-export-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded text-sm">ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸°</button>
      </div>
      <div id="stats-content" class="mt-4 max-h-96 overflow-y-auto"></div>
      <button id="stats-close-btn" class="mt-6 w-full bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">ë‹«ê¸°</button>
    </div>
  </div>

  <div id="edit-violation-modal" class="modal-backdrop hidden">
    <div class="modal-content">
      <h2 class="text-2xl font-bold mb-4 text-gray-800">ìœ„ë°˜ ê¸°ë¡ ìˆ˜ì •</h2>
      <input id="edit-doc-id" type="hidden"/>
      <div class="space-y-4">
        <div>
          <label class="block text-gray-700 text-sm font-bold mb-2">ë‚ ì§œ</label>
          <input id="edit-violation-date" type="date" class="w-full p-2 border rounded"/>
        </div>
        <div>
          <label class="block text-gray-700 text-sm font-bold mb-2">ìœ„ë°˜ ë‚´ì—­</label>
          <input id="edit-violation-details" type="text" class="w-full p-2 border rounded"/>
        </div>
      </div>
      <div class="mt-6 flex justify-end gap-4">
        <button onclick="document.getElementById('edit-violation-modal').classList.add('hidden')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">ì·¨ì†Œ</button>
        <button id="save-violation-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">ì €ì¥</button>
      </div>
    </div>
  </div>

  <div id="bulk-upload-modal" class="modal-backdrop hidden">
    <div class="modal-content">
      <h2 class="text-2xl font-bold mb-4 text-gray-800">ì—‘ì…€ë¡œ ëª…ë ¬ ì¼ê´„ ë“±ë¡</h2>
      <p class="text-sm text-gray-600 mb-2">ì—‘ì…€ì—ì„œ 'í•™ë²ˆ', 'ì´ë¦„' ë‘ ê°œ ì—´ì„ ë³µì‚¬í•˜ì—¬ ì•„ë˜ ì¹¸ì— ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>
      <p class="text-xs text-gray-500 mb-4">(ì˜ˆì‹œ: 1101  í™ê¸¸ë™)</p>
      <textarea id="bulk-data-input" rows="10" class="w-full p-2 border rounded" placeholder="ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸°..."></textarea>
      <div class="mt-6 flex justify-end gap-4">
        <button onclick="document.getElementById('bulk-upload-modal').classList.add('hidden')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">ì·¨ì†Œ</button>
        <button id="process-bulk-upload-btn" class="bg-orange-500 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded flex items-center justify-center">
          <span class="btn-text">ë“±ë¡í•˜ê¸°</span><div class="loader hidden ml-2"></div>
        </button>
      </div>
    </div>
  </div>

  <div id="year-end-modal" class="modal-backdrop hidden">
    <div class="modal-content danger">
      <h2 class="text-2xl font-bold mb-4 text-red-700">ğŸš¨ ìƒˆ í•™ë…„ë„ ì¤€ë¹„ (ì§„ê¸‰/ì¡¸ì—…) ğŸš¨</h2>
      <div class="text-gray-700 space-y-2">
        <p>ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ëŠ” ë§¤ìš° ì¤‘ìš”í•œ ì‘ì—…ì…ë‹ˆë‹¤. ì‹ ì¤‘í•˜ê²Œ ì§„í–‰í•´ì£¼ì„¸ìš”.</p>
        <p class="font-bold mt-4">ì•„ë˜ ì‘ì—…ì´ ì˜êµ¬ì ìœ¼ë¡œ ìˆ˜í–‰ë©ë‹ˆë‹¤:</p>
        <ul class="list-disc list-inside space-y-1 pl-2">
          <li>ëª¨ë“  3í•™ë…„ í•™ìƒ ëª…ë ¬ê³¼ ìœ„ë°˜ ê¸°ë¡ì´ <strong class="text-red-600">ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œ</strong>ë©ë‹ˆë‹¤.</li>
          <li>ëª¨ë“  2í•™ë…„ì€ 3í•™ë…„ìœ¼ë¡œ, 1í•™ë…„ì€ 2í•™ë…„ìœ¼ë¡œ <strong class="text-red-600">ì§„ê¸‰</strong>ë©ë‹ˆë‹¤.</li>
          <li>ì§„ê¸‰ëœ í•™ìƒë“¤ì˜ ëª¨ë“  ìœ„ë°˜ ê¸°ë¡ í•™ë²ˆë„ ìë™ìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.</li>
        </ul>
      </div>
      <div class="mt-6">
        <label class="flex items-center">
          <input id="year-end-confirm-checkbox" type="checkbox" class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500"/>
          <span class="ml-2 text-gray-800">ìœ„ ë‚´ìš©ì„ ëª¨ë‘ ì´í•´í–ˆìœ¼ë©°, í•™ë…„ ì§„ê¸‰ ì²˜ë¦¬ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.</span>
        </label>
      </div>
      <div class="mt-6 flex justify-end gap-4">
        <button onclick="document.getElementById('year-end-modal').classList.add('hidden')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">ì·¨ì†Œ</button>
        <button id="process-year-end-btn" class="bg-red-600 hover:bg-red-800 text-white font-bold py-2 px-4 rounded flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          <span class="btn-text">ì§„ê¸‰ ì²˜ë¦¬ ì‹œì‘</span><div class="loader hidden ml-2"></div>
        </button>
      </div>
    </div>
  </div>

  <div id="code-manager-modal" class="modal-backdrop hidden">
    <div class="modal-content">
      <h2 class="text-2xl font-bold mb-4 text-gray-800">ê°€ì… ì½”ë“œ ê´€ë¦¬</h2>
      <div class="space-y-4">
        <div>
          <label for="teacher-code-input" class="block text-gray-700 text-sm font-bold mb-2">êµì‚¬ ê°€ì… ì½”ë“œ</label>
          <input id="teacher-code-input" type="text" class="w-full p-2 border rounded"/>
        </div>
        <div>
          <label for="prefect-code-input" class="block text-gray-700 text-sm font-bold mb-2">ì„ ë„ë¶€ ê°€ì… ì½”ë“œ</label>
          <input id="prefect-code-input" type="text" class="w-full p-2 border rounded"/>
        </div>
      </div>
      <div class="mt-6 flex justify-end gap-4">
        <button onclick="document.getElementById('code-manager-modal').classList.add('hidden')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">ì·¨ì†Œ</button>
        <button id="save-codes-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded flex items-center justify-center">
          <span class="btn-text">ì €ì¥</span><div class="loader hidden ml-2"></div>
        </button>
      </div>
    </div>
  </div>

  <div id="prompt-modal" class="modal-backdrop hidden">
    <div class="modal-content">
      <h2 id="prompt-modal-title" class="text-xl font-bold mb-4"></h2>
      <p id="prompt-modal-message" class="text-sm text-gray-600 mb-4"></p>
      <input id="prompt-modal-input" type="text" class="w-full p-2 border rounded"/>
      <div class="mt-6 flex justify-end gap-4">
        <button id="prompt-modal-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">ì·¨ì†Œ</button>
        <button id="prompt-modal-ok-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">í™•ì¸</button>
      </div>
    </div>
  </div>

  <script type="module">
    /* ---------------- Firebase SDK ---------------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, collection, query, where, getDocs, onSnapshot, deleteDoc, updateDoc, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    /* ---------------- í™˜ê²½ì„¤ì • ---------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyC3sjU7cZe6bNKCNng20IFuKjImpQG4jAw",
      authDomain: "student-violation-tracker-2.firebaseapp.com",
      projectId: "student-violation-tracker-2",
      storageBucket: "student-violation-tracker-2.firebasestorage.app",
      messagingSenderId: "761821338774",
      appId: "1:761821338774:web:0c2dfb525af23ca4a136b7",
      measurementId: "G-BL4NTX7LRQ"
    };

    /* ---------------- ê³µí†µ ìœ í‹¸ ---------------- */
    // KST ì˜¤ëŠ˜ ë‚ ì§œ(YYYY-MM-DD)
    const todayKST = () =>
      new Intl.DateTimeFormat('en-CA', { timeZone: 'Asia/Seoul' }).format(new Date()); // en-CA â†’ 2025-08-21 í¬ë§·

    // YYYY-MM-DD â†’ KST Date ê°ì²´
    const kstDateFromYMD = (ymd) => new Date(`${ymd}T00:00:00+09:00`);

    // Firestore Timestamp/Date â†’ YYYY-MM-DD(KST)
    const formatDateKST = (tsOrDate) => {
      const d = tsOrDate?.toDate ? tsOrDate.toDate() : tsOrDate;
      return new Intl.DateTimeFormat('en-CA', { timeZone: 'Asia/Seoul' }).format(d);
    };

    const sanitizeExcel = (val) => {
      if (typeof val !== 'string') return val;
      return /^[=+\-@]/.test(val) ? `'${val}` : val;
    };

    const createDummyEmail = (name) => `${name.replace(/\s/g,'')}_${Date.now()}@school.id`;

    const toggleLoading = (btn, on) => {
      if (!btn) return;
      const t = btn.querySelector('.btn-text');
      const l = btn.querySelector('.loader');
      btn.disabled = !!on;
      if (t) t.classList.toggle('hidden', !!on);
      if (l) l.classList.toggle('hidden', !on);
    };

    function showAlert(message, title="ì•Œë¦¼"){
      acModalTitle.textContent = title;
      acModalMessage.textContent = message;
      acModalCancelBtn.classList.add('hidden');
      acModalOkBtn.textContent = 'í™•ì¸';
      acModal.classList.remove('hidden');
      return new Promise(res => { acModalOkBtn.onclick = () => { acModal.classList.add('hidden'); res(true); }; });
    }
    function showConfirm(message, title="í™•ì¸"){
      acModalTitle.textContent = title;
      acModalMessage.textContent = message;
      acModalCancelBtn.classList.remove('hidden');
      acModalOkBtn.textContent = 'í™•ì¸'; acModalCancelBtn.textContent='ì·¨ì†Œ';
      acModal.classList.remove('hidden');
      return new Promise(res => {
        acModalOkBtn.onclick = () => { acModal.classList.add('hidden'); res(true); };
        acModalCancelBtn.onclick = () => { acModal.classList.add('hidden'); res(false); };
      });
    }
    function showPrompt(title, message, def=""){
      document.getElementById('prompt-modal-title').textContent = title;
      document.getElementById('prompt-modal-message').textContent = message;
      const input = document.getElementById('prompt-modal-input');
      input.value = def;
      promptModal.classList.remove('hidden');
      input.focus();
      return new Promise(res => {
        document.getElementById('prompt-modal-ok-btn').onclick = () => { promptModal.classList.add('hidden'); res(input.value); };
        document.getElementById('prompt-modal-cancel-btn').onclick = () => { promptModal.classList.add('hidden'); res(null); };
      });
    }

    const schoolStructure = { '1': 3, '2': 4, '3': 4 };
    function createClassSelectors(containerId){
      const container = document.getElementById(containerId);
      container.innerHTML = `
        <div class="flex gap-4">
          <div class="w-1/2">
            <label for="${containerId}-grade" class="block text-sm font-bold mb-2">í•™ë…„</label>
            <select id="${containerId}-grade" class="w-full p-2 border rounded">
              ${Object.keys(schoolStructure).map(g=>`<option value="${g}">${g}í•™ë…„</option>`).join('')}
            </select>
          </div>
          <div class="w-1/2">
            <label for="${containerId}-class" class="block text-sm font-bold mb-2">ë°˜</label>
            <select id="${containerId}-class" class="w-full p-2 border rounded"></select>
          </div>
        </div>`;
      const gradeSelect = document.getElementById(`${containerId}-grade`);
      const classSelect = document.getElementById(`${containerId}-class`);
      function updateClasses(){
        const grade = gradeSelect.value;
        const count = schoolStructure[grade];
        classSelect.innerHTML = Array.from({length:count}, (_,i)=>i+1).map(c=>`<option value="${c}">${c}ë°˜</option>`).join('');
      }
      gradeSelect.addEventListener('change', updateClasses);
      updateClasses();
    }

    /* ---------------- ì „ì—­ ìƒíƒœ/DOM ---------------- */
    let auth, db, currentUserRole, currentUserName;
    const ADMIN_UID = "XRi2i7XcXSf6MLM3poTVX6Soorw1";

    const appContainer = document.getElementById('app-container');
    const loadingScreen = document.getElementById('loading-screen');
    const loadingStatus = document.getElementById('loading-status');
    const progressBar = document.getElementById('progress-bar');

    const loginSection = document.getElementById('login-section');
    const registerSection = document.getElementById('register-section');
    const mainAppSection = document.getElementById('main-app-section');
    const adminControls = document.getElementById('admin-controls');
    const teacherMenu = document.getElementById('teacher-menu');
    const mainTitle = document.getElementById('main-title');
    const violationDateInput = document.getElementById('violation-date');

    // ëª¨ë‹¬ DOM
    const acModal = document.getElementById('alert-confirm-modal');
    const acModalTitle = document.getElementById('ac-modal-title');
    const acModalMessage = document.getElementById('ac-modal-message');
    const acModalOkBtn = document.getElementById('ac-modal-ok-btn');
    const acModalCancelBtn = document.getElementById('ac-modal-cancel-btn');
    const promptModal = document.getElementById('prompt-modal');

    /* ---------------- ì´ˆê¸°í™” ---------------- */
    function updateLoadingProgress(p, msg){ progressBar.style.width = `${p}%`; loadingStatus.textContent = msg; }

    window.addEventListener('load', () => {
      main().catch(err=>{
        loadingStatus.textContent = "ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì˜¤ë¥˜ ë°œìƒ. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.";
        console.error("Initialization Error:", err);
      });
    });

    async function main(){
      updateLoadingProgress(25, 'Firebase ì•± ì´ˆê¸°í™” ì¤‘...');
      const app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);

      updateLoadingProgress(50, 'ì¸ì¦ ì„œë¹„ìŠ¤ ì—°ê²° ì¤‘...');

      onAuthStateChanged(auth, async (user) => {
        updateLoadingProgress(75, 'ì‚¬ìš©ì ì •ë³´ í™•ì¸ ì¤‘...');
        try{
          if (user){
            // ì‚¬ìš©ì ì—­í• /ì´ë¦„ ë¡œë“œ
            const userDocSnap = await getDoc(doc(db, "users", user.uid));
            if (userDocSnap.exists()){
              const data = userDocSnap.data();
              currentUserRole = data.role;
              currentUserName = data.name;
            }

            // ê³ ì • ê´€ë¦¬ì UID ê°•ì œ ë³´ì •
            if (user.uid === ADMIN_UID && currentUserRole !== 'admin') {
              await setDoc(doc(db, "users", user.uid), { role: 'admin', name: currentUserName || 'ê´€ë¦¬ì' }, { merge: true });
              currentUserRole = 'admin';
            }

            loginSection.classList.add('hidden');
            registerSection.classList.add('hidden');
            mainAppSection.classList.remove('hidden');

            const isAdmin = currentUserRole === 'admin';
            const isTeacher = currentUserRole === 'teacher';

            adminControls.classList.toggle('hidden', !isAdmin);
            teacherMenu.classList.toggle('hidden', !(isAdmin || isTeacher));

            listenToTitle();
            violationDateInput.value = todayKST(); // ë‚ ì§œ ê¸°ë³¸ê°’(KST)
          } else {
            currentUserRole = null;
            currentUserName = null;
            loginSection.classList.remove('hidden');
            registerSection.classList.add('hidden');
            mainAppSection.classList.add('hidden');
          }
        }catch(e){
          console.error(e);
          await showAlert("ì´ˆê¸° ì„¤ì • ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        }finally{
          updateLoadingProgress(100, 'ë¡œë”© ì™„ë£Œ!');
          setTimeout(()=>{
            appContainer.classList.remove('hidden');
            loadingScreen.classList.add('hidden');
          }, 300);
        }
      });
    }

    function listenToTitle(){
      // ì‹¤ì‹œê°„ ì œëª© ë¦¬ìŠ¤ë„ˆ (ë‹¨ì¼ êµ¬ë…)
      onSnapshot(doc(db, "config", "mainSettings"), (snap)=>{
        mainTitle.textContent = snap.exists() ? (snap.data().title || "í•™ìƒì§€ë„ ì‚¬í•­") : "í•™ìƒì§€ë„ ì‚¬í•­";
      }, (err)=>{
        console.error("listenToTitle error:", err);
        mainTitle.textContent = "í•™ìƒì§€ë„ ì‚¬í•­";
      });
    }

    /* ---------------- ì´ë²¤íŠ¸ ë°”ì¸ë”© ---------------- */
    document.getElementById('show-register-link').addEventListener('click', (e)=>{ e.preventDefault(); loginSection.classList.add('hidden'); registerSection.classList.remove('hidden'); });
    document.getElementById('show-login-link').addEventListener('click', (e)=>{ e.preventDefault(); loginSection.classList.remove('hidden'); registerSection.classList.add('hidden'); });

    document.getElementById('login-btn').addEventListener('click', async (e)=>{
      const btn = e.currentTarget;
      toggleLoading(btn, true);
      const name = document.getElementById('login-name').value.trim();
      const password = document.getElementById('password').value;

      if (!name || !password){
        toggleLoading(btn, false);
        return showAlert("ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      }

      try{
        // ì´ë¦„ìœ¼ë¡œ ì´ë©”ì¼ ì°¾ê¸°
        const usersRef = collection(db, "users");
        const q = query(usersRef, where("name", "==", name));
        const qs = await getDocs(q);
        if (qs.empty) throw new Error("User not found");
        const userDoc = qs.docs[0].data();
        const email = userDoc.email;
        await signInWithEmailAndPassword(auth, email, password);
      }catch(err){
        document.getElementById('login-error').textContent = "ì´ë¦„ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.";
        console.error(err);
      }finally{
        toggleLoading(btn, false);
      }
    });

    document.getElementById('logout-btn').addEventListener('click', ()=> signOut(auth));

    document.getElementById('register-btn').addEventListener('click', async (e)=>{
      const btn = e.currentTarget;
      toggleLoading(btn, true);

      const name = document.getElementById('register-name').value.trim();
      const password = document.getElementById('register-password').value;
      const code = document.getElementById('register-code').value.trim();

      if (!name || !password || !code){
        toggleLoading(btn, false);
        return showAlert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      }

      try{
        // ì´ë¦„ ì¤‘ë³µ ì²´í¬
        const q1 = query(collection(db, "users"), where("name", "==", name));
        const snap1 = await getDocs(q1);
        if (!snap1.empty){
          toggleLoading(btn, false);
          return showAlert("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë¦„ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¦„ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
        }

        // ê°€ì… ì½”ë“œ í™•ì¸
        const codesSnap = await getDoc(doc(db, "config", "registrationCodes"));
        if (!codesSnap.exists()){
          toggleLoading(btn, false);
          return showAlert("ê°€ì… ì½”ë“œê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
        }
        const { teacher, prefect } = codesSnap.data();
        let role = null;
        if (code === teacher) role = 'teacher';
        else if (code === prefect) role = 'prefect';
        if (!role){
          toggleLoading(btn, false);
          return showAlert("ê°€ì… ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }

        const email = createDummyEmail(name);
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, "users", cred.user.uid), { role, name, email }, { merge:true });
        await showAlert("íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ë©ë‹ˆë‹¤.");
      }catch(err){
        if (err.code === 'auth/email-already-in-use') showAlert("ë‚´ë¶€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        else if (err.code === 'auth/weak-password') showAlert("ë¹„ë°€ë²ˆí˜¸ëŠ” 6ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
        else showAlert("íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        console.error("ê°€ì… ì˜¤ë¥˜:", err);
      }finally{
        toggleLoading(btn, false);
      }
    });

    // ê¸°ë¡ ì œì¶œ
    document.getElementById('submit-btn').addEventListener('click', async (e)=>{
      const btn = e.currentTarget;
      toggleLoading(btn, true);

      const studentId = document.getElementById('student-id').value.trim();
      const studentName = document.getElementById('student-name').value.trim();
      const details = document.getElementById('violation-details').value.trim();
      const dateStr = violationDateInput.value;

      if (!dateStr || !studentId || !studentName || !details){
        toggleLoading(btn, false);
        return showAlert("ë‚ ì§œ, í•™ë²ˆ, ì´ë¦„, ìœ„ë°˜ ë‚´ì—­ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      }
      if (!/^\d{4}$/.test(studentId)){
        toggleLoading(btn, false);
        return showAlert("í•™ë²ˆì€ 4ìë¦¬ ìˆ«ì(í•™ë…„+ë°˜+ë²ˆí˜¸)ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      }

      try{
        const studentDoc = await getDoc(doc(db, "students", studentId));
        if (!studentDoc.exists()){
          toggleLoading(btn, false);
          return showAlert("ëª…ë ¬ì— ì—†ëŠ” í•™ìƒì…ë‹ˆë‹¤. í•™ë²ˆê³¼ ì´ë¦„ì„ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.");
        }

        // KST ê¸°ì¤€ ë‚ ì§œ ì €ì¥
        const kstDate = kstDateFromYMD(dateStr);
        await addDoc(collection(db, "violations"), {
          studentId,
          studentName,
          details,
          teacherId: (auth.currentUser && auth.currentUser.uid) || '',
          recorderName: currentUserName || '',
          recorderRole: currentUserRole || '',
          timestamp: kstDate
        });

        // ëˆ„ì  ì¡°íšŒ
        const q = query(collection(db, "violations"), where("studentId", "==", studentId));
        const vs = await getDocs(q);
        const totalViolations = vs.size;
        const past = vs.docs.map(d=>d.data())
          .sort((a,b)=> (a.timestamp?.toMillis?.()||new Date(a.timestamp).getTime()) < (b.timestamp?.toMillis?.()||new Date(b.timestamp).getTime()) ? 1 : -1);

        const box = document.getElementById('result-modal-content-box');
        const title = document.getElementById('result-modal-title');
        box.classList.remove('danger');
        if (totalViolations >= 3){
          box.classList.add('danger');
          title.textContent = 'ğŸš¨ íŠ¹ë³„ ê´€ë¦¬ ëŒ€ìƒ ğŸš¨';
        }else{
          title.textContent = 'ê¸°ë¡ ì™„ë£Œ';
        }

        document.getElementById('result-content').innerHTML = `
          <p class="text-lg"><strong class="text-red-500 text-xl">${totalViolations}ë²ˆì§¸</strong> ìœ„ë°˜ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
          <div class="mt-2 text-sm bg-gray-50 p-2 rounded">
            <p><strong>ë‚ ì§œ:</strong> ${dateStr}</p>
            <p><strong>í•™ìƒ:</strong> ${studentId} ${studentName}</p>
            <p><strong>ìœ„ë°˜ë‚´ì—­:</strong> ${details}</p>
          </div>
          <div class="mt-4 pt-4 border-t max-h-48 overflow-y-auto">
            <h3 class="font-bold mb-2">ì „ì²´ ìœ„ë°˜ ê¸°ë¡ (${totalViolations}ê±´)</h3>
            <ul class="list-disc list-inside text-sm space-y-1">
              ${past.map(v => `<li><span class="font-semibold">${formatDateKST(v.timestamp)}:</span> ${v.details}</li>`).join('')}
            </ul>
          </div>
        `;
        document.getElementById('result-modal').classList.remove('hidden');

        ['student-id','student-name','violation-details'].forEach(id=>document.getElementById(id).value='');
        violationDateInput.value = todayKST();
      }catch(err){
        console.error("ì œì¶œ ì˜¤ë¥˜:", err);
        showAlert("ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }finally{
        toggleLoading(btn, false);
      }
    });
    document.getElementById('result-modal-ok-btn').addEventListener('click', ()=> document.getElementById('result-modal').classList.add('hidden'));

    /* ----- ë°˜ë³„ ì¡°íšŒ ----- */
    let currentAction = null;
    const classSelectorModal = document.getElementById('class-selector-modal');
    const classSelectorTitle = document.getElementById('class-selector-title');

    document.getElementById('view-by-class-btn').addEventListener('click', ()=>{
      currentAction = 'viewLog';
      classSelectorTitle.textContent = 'ì¡°íšŒí•  í•™ê¸‰ ì„ íƒ';
      createClassSelectors('class-selector-container');
      classSelectorModal.classList.remove('hidden');
    });
    document.getElementById('class-selector-cancel-btn').addEventListener('click', ()=> classSelectorModal.classList.add('hidden'));

    document.getElementById('class-selector-confirm-btn').addEventListener('click', async ()=>{
      const grade = document.getElementById('class-selector-container-grade').value;
      const studentClass = document.getElementById('class-selector-container-class').value;
      classSelectorModal.classList.add('hidden');

      if (currentAction === 'viewLog') await showClassLog(grade, studentClass);
      else if (currentAction === 'viewStats') await showMonthlyStats(grade, studentClass); // âœ… ë²„ê·¸ ìˆ˜ì •: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” showReport â†’ showMonthlyStats
    });

    async function showClassLog(grade, studentClass){
      const classPrefix = grade + studentClass;
      document.getElementById('class-log-title').textContent = `${grade}í•™ë…„ ${studentClass}ë°˜ ìœ„ë°˜ ê¸°ë¡`;
      const logContent = document.getElementById('class-log-content');
      logContent.innerHTML = `<div class="flex justify-center p-4"><div class="loader"></div></div>`;
      document.getElementById('class-log-modal').classList.remove('hidden');

      try{
        const q1 = query(
          collection(db, "violations"),
          where("studentId", ">=", classPrefix + "00"),
          where("studentId", "<=", classPrefix + "99")
        );
        const qs = await getDocs(q1);
        const violations = qs.docs.map(d=>({ id:d.id, ...d.data() }))
          .sort((a,b)=> (a.timestamp?.toMillis?.()||new Date(a.timestamp).getTime()) < (b.timestamp?.toMillis?.()||new Date(b.timestamp).getTime()) ? 1 : -1);

        if (violations.length === 0){
          logContent.innerHTML = `<p class="text-center text-gray-500">ìœ„ë°˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
        }else{
          logContent.innerHTML = `
            <table class="w-full text-sm text-left text-gray-500">
              <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                <tr>
                  <th class="px-2 py-2">ë‚ ì§œ</th>
                  <th class="px-2 py-2">í•™ìƒ</th>
                  <th class="px-2 py-2">ë‚´ì—­</th>
                  <th class="px-2 py-2">ì‘ì„±ì</th>
                  <th class="px-2 py-2 text-right">ê´€ë¦¬</th>
                </tr>
              </thead>
              <tbody>
                ${violations.map(d=>{
                  const date = formatDateKST(d.timestamp);
                  const isAdmin = currentUserRole === 'admin';
                  const rr = d.recorderRole === 'teacher' ? 'êµì‚¬' : d.recorderRole === 'prefect' ? 'ì„ ë„ë¶€' : 'ê´€ë¦¬ì';
                  const who = `${d.recorderName || ''} (${rr})`;
                  const controls = isAdmin ? `<button class="edit-btn text-blue-500 mr-2" data-id="${d.id}">ìˆ˜ì •</button><button class="delete-btn text-red-500" data-id="${d.id}">ì‚­ì œ</button>` : '';
                  return `<tr class="border-b">
                    <td class="px-2 py-2">${date}</td>
                    <td class="px-2 py-2">${d.studentId} ${d.studentName}</td>
                    <td class="px-2 py-2">${d.details}</td>
                    <td class="px-2 py-2">${who}</td>
                    <td class="px-2 py-2 text-right">${controls}</td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>`;
        }
      }catch(err){
        console.error("ë°˜ë³„ ê¸°ë¡ ì¡°íšŒ ì˜¤ë¥˜:", err);
        logContent.innerHTML = `<p class="text-center text-red-500">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>`;
      }
    }
    document.getElementById('class-log-close-btn').addEventListener('click', ()=> document.getElementById('class-log-modal').classList.add('hidden'));

    document.getElementById('class-log-content').addEventListener('click', async (e)=>{
      const t = e.target;
      const id = t.dataset.id;
      if (!id || currentUserRole !== 'admin') return;

      if (t.classList.contains('edit-btn')){
        const snap = await getDoc(doc(db, "violations", id));
        if (snap.exists()){
          const data = snap.data();
          document.getElementById('edit-doc-id').value = id;
          document.getElementById('edit-violation-date').value = formatDateKST(data.timestamp);
          document.getElementById('edit-violation-details').value = data.details;
          document.getElementById('edit-violation-modal').classList.remove('hidden');
        }
      }else if (t.classList.contains('delete-btn')){
        if (await showConfirm("ì´ ìœ„ë°˜ ê¸°ë¡ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
          await deleteDoc(doc(db, "violations", id));
          await showAlert("ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
          const title = document.getElementById('class-log-title').textContent;
          const grade = title.charAt(0);
          const studentClass = title.split(' ')[1].replace('ë°˜','');
          await showClassLog(grade, studentClass);
        }
      }
    });

    document.getElementById('save-violation-btn').addEventListener('click', async ()=>{
      const id = document.getElementById('edit-doc-id').value;
      const newDate = document.getElementById('edit-violation-date').value;
      const newDetails = document.getElementById('edit-violation-details').value;
      if (!newDate || !newDetails) return showAlert("ë‚ ì§œì™€ ìœ„ë°˜ ë‚´ì—­ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
      await updateDoc(doc(db, "violations", id), { timestamp: kstDateFromYMD(newDate), details: newDetails });
      document.getElementById('edit-violation-modal').classList.add('hidden');
      await showAlert("ê¸°ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
      const title = document.getElementById('class-log-title').textContent;
      const grade = title.charAt(0);
      const studentClass = title.split(' ')[1].replace('ë°˜','');
      await showClassLog(grade, studentClass);
    });

    /* ----- í•™ìƒ ëª…ë ¬ ê´€ë¦¬(ê´€ë¦¬ì) ----- */
    document.getElementById('manage-students-btn').addEventListener('click', ()=>{
      createClassSelectors('student-list-selector');
      document.getElementById('student-list-modal').classList.remove('hidden');
      const gSel = document.getElementById('student-list-selector-grade');
      const cSel = document.getElementById('student-list-selector-class');
      const render = async ()=> renderStudentList(gSel.value, cSel.value);
      gSel.addEventListener('change', render);
      cSel.addEventListener('change', render);
      render();
    });

    async function renderStudentList(grade, studentClass){
      const box = document.getElementById('student-list-content');
      box.innerHTML = `<div class="flex justify-center p-4"><div class="loader"></div></div>`;
      const prefix = grade + studentClass;
      try{
        const q1 = query(collection(db, "students"),
          where("__name__", ">=", prefix + "00"),
          where("__name__", "<=", prefix + "99"));
        const qs = await getDocs(q1);
        const list = qs.docs.map(d=>({ id:d.id, ...d.data() })).sort((a,b)=> a.id.localeCompare(b.id));
        if (!list.length){
          box.innerHTML = `<p class="text-center text-gray-500">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
        }else{
          box.innerHTML = `
            <table class="w-full text-sm">
              ${list.map(s=>`
                <tr class="border-b">
                  <td class="py-1">${s.id}</td>
                  <td>${s.name}</td>
                  <td class="text-right"><button class="delete-student-btn text-red-500" data-id="${s.id}">ì‚­ì œ</button></td>
                </tr>`).join('')}
            </table>`;
        }
      }catch(err){
        console.error("í•™ìƒ ëª…ë ¬ ì¡°íšŒ ì˜¤ë¥˜:", err);
        box.innerHTML = `<p class="text-center text-red-500">ëª…ë ¬ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>`;
      }
    }

    const addStudentBtn = document.getElementById('add-student-btn');
    const addStudentAction = async ()=>{
      toggleLoading(addStudentBtn, true);
      const grade = document.getElementById('student-list-selector-grade').value;
      const studentClass = document.getElementById('student-list-selector-class').value;
      const number = document.getElementById('new-student-id-suffix').value.trim().padStart(2,'0');
      const name = document.getElementById('new-student-name').value.trim();

      if (!number || !name || number.length !== 2){
        toggleLoading(addStudentBtn, false);
        return showAlert("ì •í™•í•œ ë²ˆí˜¸(2ìë¦¬)ì™€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
      }

      const id = grade + studentClass + number;
      try{
        await setDoc(doc(db, "students", id), { name });
        await showAlert("í•™ìƒì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
        document.getElementById('new-student-id-suffix').value='';
        document.getElementById('new-student-name').value='';
        await renderStudentList(grade, studentClass);
      }catch(err){
        console.error("í•™ìƒ ì¶”ê°€ ì˜¤ë¥˜:", err);
        showAlert("í•™ìƒ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }finally{
        toggleLoading(addStudentBtn, false);
      }
    };
    addStudentBtn.addEventListener('click', addStudentAction);
    document.getElementById('new-student-name').addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ e.preventDefault(); addStudentAction(); } });

    document.getElementById('student-list-content').addEventListener('click', async (e)=>{
      if (e.target.classList.contains('delete-student-btn')){
        const id = e.target.dataset.id;
        if (await showConfirm(`í•™ë²ˆ ${id} í•™ìƒì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)){
          await deleteDoc(doc(db, "students", id));
          const g = document.getElementById('student-list-selector-grade').value;
          const c = document.getElementById('student-list-selector-class').value;
          await renderStudentList(g, c);
        }
      }
    });

    // ì œëª© ìˆ˜ì •
    document.getElementById('edit-title-btn').addEventListener('click', async ()=>{
      const newTitle = await showPrompt("í˜ì´ì§€ ì œëª© ìˆ˜ì •", "ìƒˆë¡œìš´ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:", mainTitle.textContent);
      if (newTitle?.trim()){
        await setDoc(doc(db, "config", "mainSettings"), { title: newTitle.trim() }, { merge:true });
        await showAlert("ì œëª©ì´ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }
    });

    // ì¼ê´„ ì—…ë¡œë“œ
    document.getElementById('bulk-upload-btn').addEventListener('click', ()=> document.getElementById('bulk-upload-modal').classList.remove('hidden'));
    document.getElementById('process-bulk-upload-btn').addEventListener('click', async (e)=>{
      const btn = e.currentTarget;
      toggleLoading(btn, true);
      const data = document.getElementById('bulk-data-input').value.trim();
      if (!data){
        toggleLoading(btn, false);
        return showAlert("ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      }

      const lines = data.split('\n');
      const batch = writeBatch(db);
      let ok=0, fail=0;
      lines.forEach(line=>{
        const parts = line.split(/\s+/);
        if (parts.length>=2){
          const sid = parts[0].trim();
          const name = parts.slice(1).join(' ').trim();
          if (/^\d{4}$/.test(sid) && name){
            batch.set(doc(db,"students", sid), { name });
            ok++;
          }else fail++;
        }else fail++;
      });

      if (ok===0){
        toggleLoading(btn, false);
        return showAlert("ì˜¬ë°”ë¥¸ í˜•ì‹ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. 'í•™ë²ˆ ì´ë¦„' í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      }

      try{
        await batch.commit();
        document.getElementById('bulk-upload-modal').classList.add('hidden');
        document.getElementById('bulk-data-input').value='';
        await showAlert(`${ok}ëª…ì˜ í•™ìƒì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. (ì‹¤íŒ¨: ${fail}ê±´)`);
      }catch(err){
        console.error("ì¼ê´„ ë“±ë¡ ì˜¤ë¥˜:", err);
        showAlert("ì¼ê´„ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }finally{
        toggleLoading(btn, false);
      }
    });

    // í•™ë…„ë§
    document.getElementById('year-end-btn').addEventListener('click', ()=>{
      document.getElementById('year-end-modal').classList.remove('hidden');
      document.getElementById('year-end-confirm-checkbox').checked = false;
      document.getElementById('process-year-end-btn').disabled = true;
    });
    document.getElementById('year-end-confirm-checkbox').addEventListener('change', (e)=>{
      document.getElementById('process-year-end-btn').disabled = !e.target.checked;
    });
    document.getElementById('process-year-end-btn').addEventListener('click', async (e)=>{
      const confirm1 = await showConfirm("ì •ë§ë¡œ ëª¨ë“  3í•™ë…„ì„ ì¡¸ì—…ì‹œí‚¤ê³  ì¬í•™ìƒì„ ì§„ê¸‰ì‹œí‚¤ê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      if (!confirm1) return;
      const final = await showPrompt("ë§ˆì§€ë§‰ í™•ì¸", "ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤. ì§„í–‰í•˜ì‹œë ¤ë©´ 'ì§„ê¸‰'ì´ë¼ê³  ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      if (final !== 'ì§„ê¸‰') return showAlert("ì…ë ¥ì´ ì¼ì¹˜í•˜ì§€ ì•Šì•„ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");

      const btn = e.currentTarget;
      toggleLoading(btn, true);
      try{
        const studentsSnap = await getDocs(collection(db,"students"));
        const violationsSnap = await getDocs(collection(db,"violations"));
        const batch = writeBatch(db);

        const students = studentsSnap.docs.map(d=>({ id:d.id, ...d.data() }));
        const violations = violationsSnap.docs.map(d=>({ id:d.id, ...d.data() }));

        for (const s of students){
          const g = s.id.charAt(0);
          if (g==='3'){ batch.delete(doc(db,"students", s.id)); }
          else if (g==='2' || g==='1'){
            const newId = String(Number(g)+1) + s.id.substring(1);
            batch.set(doc(db,"students", newId), { name:s.name });
            batch.delete(doc(db,"students", s.id));
          }
        }

        for (const v of violations){
          const g = v.studentId?.charAt(0);
          if (g==='3'){ batch.delete(doc(db,"violations", v.id)); }
          else if (g==='2' || g==='1'){
            const newId = String(Number(g)+1) + v.studentId.substring(1);
            batch.update(doc(db,"violations", v.id), { studentId:newId });
          }
        }

        await batch.commit();
        document.getElementById('year-end-modal').classList.add('hidden');
        await showAlert("í•™ë…„ ì§„ê¸‰ ì²˜ë¦¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. 1í•™ë…„ í•™ìƒë“¤ì€ 'ì—‘ì…€ë¡œ ì¼ê´„ ë“±ë¡' ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì—¬ ìƒˆë¡œ ë“±ë¡í•´ì£¼ì„¸ìš”.");
      }catch(err){
        console.error("í•™ë…„ ì§„ê¸‰ ì²˜ë¦¬ ì˜¤ë¥˜:", err);
        await showAlert("í•™ë…„ ì§„ê¸‰ ì²˜ë¦¬ ì¤‘ ì‹¬ê°í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
      }finally{
        toggleLoading(btn, false);
      }
    });

    // ê°€ì… ì½”ë“œ ê´€ë¦¬(ê´€ë¦¬ì)
    document.getElementById('manage-codes-btn').addEventListener('click', async ()=>{
      const snap = await getDoc(doc(db,"config","registrationCodes"));
      if (snap.exists()){
        const codes = snap.data();
        document.getElementById('teacher-code-input').value = codes.teacher || '';
        document.getElementById('prefect-code-input').value = codes.prefect || '';
      }
      document.getElementById('code-manager-modal').classList.remove('hidden');
    });
    document.getElementById('save-codes-btn').addEventListener('click', async (e)=>{
      const btn = e.currentTarget;
      toggleLoading(btn, true);
      try{
        const teacher = document.getElementById('teacher-code-input').value.trim();
        const prefect = document.getElementById('prefect-code-input').value.trim();
        await setDoc(doc(db,"config","registrationCodes"), { teacher, prefect }, { merge:true });
        await showAlert("ê°€ì… ì½”ë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        document.getElementById('code-manager-modal').classList.add('hidden');
      }catch(err){
        console.error("ì½”ë“œ ì €ì¥ ì˜¤ë¥˜:", err);
        await showAlert("ì½”ë“œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }finally{
        toggleLoading(btn, false);
      }
    });

    /* ----- ì›”ë³„ í†µê³„ (ê´€ë¦¬ì) ----- */
    const statsBtn = document.getElementById('show-stats-btn');
    statsBtn.addEventListener('click', ()=>{
      currentAction = 'viewStats';
      classSelectorTitle.textContent = 'í†µê³„ë¥¼ ë³¼ í•™ê¸‰ ì„ íƒ';
      createClassSelectors('class-selector-container');
      classSelectorModal.classList.remove('hidden');
    });

    async function showMonthlyStats(grade, studentClass){
      const statsModal = document.getElementById('stats-modal');
      const statsTitle = document.getElementById('stats-title');
      const statsContent = document.getElementById('stats-content');

      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth(); // ì´ë²ˆ ë‹¬
      statsTitle.textContent = `${year}ë…„ ${month+1}ì›” í†µê³„ (${grade}í•™ë…„ ${studentClass}ë°˜)`;
      statsContent.innerHTML = `<div class="flex justify-center p-4"><div class="loader"></div></div>`;
      statsModal.classList.remove('hidden');

      const start = new Date(year, month, 1);
      const end = new Date(year, month+1, 0, 23, 59, 59);
      const classPrefix = grade + studentClass;

      try{
        // âš ï¸ Firestore ì œì•½: ì„œë¡œ ë‹¤ë¥¸ í•„ë“œì˜ ë²”ìœ„ ì¡°ê±´ ë™ì‹œ ì‚¬ìš© ë¶ˆê°€
        // â†’ timestamp ë²”ìœ„ë§Œ ì¿¼ë¦¬í•˜ê³ , í•™ê¸‰(prefix)ì€ í´ë¼ì´ì–¸íŠ¸ì—ì„œ í•„í„°ë§
        const q1 = query(
          collection(db,"violations"),
          where("timestamp", ">=", start),
          where("timestamp", "<=", end)
        );
        const qs = await getDocs(q1);
        const filtered = qs.docs
          .map(d=>d.data())
          .filter(v => typeof v.studentId === 'string' && v.studentId.startsWith(classPrefix));

        if (filtered.length === 0){
          statsContent.innerHTML = `<p class="text-center text-gray-500">ì´ë²ˆ ë‹¬ ìœ„ë°˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
          return;
        }

        // í•™ìƒë³„ ì›”ê°„/ì´ í•©ì‚°
        const ids = [...new Set(filtered.map(v=>v.studentId))];
        // ì´ ìœ„ë°˜ ìˆ˜ (N+1 ì¿¼ë¦¬; í˜„ì¬ ê·œëª¨ ê¸°ì¤€ í—ˆìš©)
        const totalCounts = {};
        const promises = ids.map(id=> getDocs(query(collection(db,"violations"), where("studentId","==", id))));
        const all = await Promise.all(promises);
        all.forEach((snap,i)=> totalCounts[ids[i]] = snap.size);

        const nameById = {};
        filtered.forEach(v => { nameById[v.studentId] = v.studentName; });

        const monthlyCounts = {};
        filtered.forEach(v => { monthlyCounts[v.studentId] = (monthlyCounts[v.studentId]||0)+1; });

        const rows = ids.map(id => ({
          í•™ë²ˆ: id,
          ì´ë¦„: nameById[id] || '',
          ì›”ê°„ìœ„ë°˜: monthlyCounts[id],
          ì´ìœ„ë°˜: totalCounts[id] || monthlyCounts[id]
        })).sort((a,b)=> b.ì›”ê°„ìœ„ë°˜ - a.ì›”ê°„ìœ„ë°˜);

        statsContent.innerHTML = `
          <table class="w-full text-sm text-left text-gray-500">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
              <tr><th class="px-4 py-2">í•™ë²ˆ</th><th class="px-4 py-2">ì´ë¦„</th><th class="px-4 py-2 text-center">ì›”ê°„ ìœ„ë°˜</th><th class="px-4 py-2 text-center">ì´ ìœ„ë°˜</th></tr>
            </thead>
            <tbody>
              ${rows.map(s=>`
                <tr class="border-b">
                  <td class="px-4 py-2">${s.í•™ë²ˆ}</td>
                  <td class="px-4 py-2">${s.ì´ë¦„}</td>
                  <td class="px-4 py-2 text-center">${s.ì›”ê°„ìœ„ë°˜}</td>
                  <td class="px-4 py-2 text-center">${s.ì´ìœ„ë°˜}</td>
                </tr>`).join('')}
            </tbody>
          </table>`;
      }catch(err){
        console.error("ì›”ë³„ í†µê³„ ì¡°íšŒ ì˜¤ë¥˜:", err);
        statsContent.innerHTML = `<p class="text-center text-red-500">í†µê³„ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>`;
      }
    }
    document.getElementById('stats-close-btn').addEventListener('click', ()=> document.getElementById('stats-modal').classList.add('hidden'));

    /* ----- ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ----- */
    async function exportToExcel(data, filename){
      // ë³´ì•ˆ: ìˆ˜ì‹ ì£¼ì… ë°©ì§€
      const safe = data.map(row=>{
        const out = {};
        Object.keys(row).forEach(k=>{
          out[k] = sanitizeExcel(row[k]);
        });
        return out;
      });
      const ws = XLSX.utils.json_to_sheet(safe);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
      XLSX.writeFile(wb, filename);
      await showAlert("ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    document.getElementById('class-log-export-btn').addEventListener('click', async ()=>{
      const title = document.getElementById('class-log-title').textContent; // ì˜ˆ: "1í•™ë…„ 2ë°˜ ìœ„ë°˜ ê¸°ë¡"
      const grade = title.charAt(0);
      const studentClass = title.split(' ')[1].replace('ë°˜','');
      const classPrefix = grade + studentClass;

      const q1 = query(collection(db,"violations"),
        where("studentId", ">=", classPrefix + "00"),
        where("studentId", "<=", classPrefix + "99"));
      const qs = await getDocs(q1);
      const violations = qs.docs.map(d=>({ id:d.id, ...d.data() }));
      if (!violations.length) return showAlert("ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

      const studentIds = [...new Set(violations.map(v=>v.studentId))];
      const totalCounts = {};
      const snaps = await Promise.all(studentIds.map(id=> getDocs(query(collection(db,"violations"), where("studentId","==", id)))));
      snaps.forEach((snap, i)=> totalCounts[studentIds[i]] = snap.size);

      const exportData = violations
        .sort((a,b)=> (a.timestamp?.toMillis?.()||new Date(a.timestamp).getTime()) < (b.timestamp?.toMillis?.()||new Date(b.timestamp).getTime()) ? 1 : -1)
        .map(v=>({
          "í•™ë…„": v.studentId?.charAt(0) || '',
          "ë°˜": v.studentId?.charAt(1) || '',
          "í•™ë²ˆ": v.studentId,
          "ì´ë¦„": v.studentName,
          "ìœ„ë°˜ì¼": formatDateKST(v.timestamp),
          "ìœ„ë°˜ë‚´ì—­": v.details,
          "ì´ ìœ„ë°˜íšŸìˆ˜": totalCounts[v.studentId] || ''
        }));

      exportToExcel(exportData, `${grade}í•™ë…„${studentClass}ë°˜_ìœ„ë°˜ê¸°ë¡.xlsx`);
    });

    document.getElementById('stats-export-btn').addEventListener('click', async ()=>{
      const title = document.getElementById('stats-title').textContent;
      const table = document.getElementById('stats-content').querySelector('table');
      if (!table) return showAlert("ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
      const ws = XLSX.utils.table_to_sheet(table);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "ì›”ë³„ í†µê³„");
      XLSX.writeFile(wb, `${title}.xlsx`);
    });

    /* ----- ê¸°íƒ€ ë²„íŠ¼ ----- */
    document.getElementById('class-log-close-btn').addEventListener('click', ()=> document.getElementById('class-log-modal').classList.add('hidden'));
  </script>
</body>
</html>
